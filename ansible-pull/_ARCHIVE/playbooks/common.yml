# INFO: playbooks/common.yml â€” minimal, YAML-safe runtime grouping + routed execution
# INFO: This file avoids folded scalars and compact mappings to prevent YAML parser errors.

- name: INFO: Runtime classify host and register in-memory inventory
  hosts: localhost
  gather_facts: true
  vars: {}
  tasks:

    - name: INFO: Determine node_name from facts or inventory
      set_fact:
        node_name: "{{ ansible_facts['nodename'] | default(inventory_hostname) }}"

    - name: INFO: Debug node_name
      debug:
        msg: "node_name={{ node_name }}"

    - name: INFO: Set top_group to server_all when hostname starts with srv-
      set_fact:
        top_group: "server_all"
      when: node_name is string and node_name.startswith('srv-')

    - name: INFO: Set top_group to desktop_all when hostname starts with ws-
      set_fact:
        top_group: "desktop_all"
      when: node_name is string and node_name.startswith('ws-')

    - name: INFO: Ensure top_group is defined (fallback to ungrouped)
      set_fact:
        top_group: "ungrouped"
      when: top_group is not defined

    - name: INFO: Show top_group
      debug:
        msg: "top_group={{ top_group }}"

    - name: INFO: Create top-level group (server_all / desktop_all / ungrouped)
      group_by:
        key: "{{ top_group }}"

    - name: INFO: Group server_iac if hostname contains srv-iac
      group_by:
        key: "server_iac"
      when: node_name is string and "'srv-iac' in node_name"

    - name: INFO: Group server_swarm_manager if hostname contains srv-docker-mgr
      group_by:
        key: "server_swarm_manager"
      when: node_name is string and "'srv-docker-mgr' in node_name"

    - name: INFO: Group server_swarm_host if hostname contains srv-docker-host
      group_by:
        key: "server_swarm_host"
      when: node_name is string and "'srv-docker-host' in node_name"

    - name: INFO: Group server_utility if hostname contains srv-utl
      group_by:
        key: "server_utility"
      when: node_name is string and "'srv-utl' in node_name"

    - name: INFO: Group desktop_general if hostname contains ws-gen
      group_by:
        key: "desktop_general"
      when: node_name is string and "'ws-gen' in node_name"

    - name: INFO: Group desktop_development if hostname contains ws-dev
      group_by:
        key: "desktop_development"
      when: node_name is string and "'ws-dev' in node_name"

    - name: INFO: Group prod when second-last char is 'p'
      group_by:
        key: "prod"
      when: node_name is string and (node_name | length) >= 2 and node_name[-2] == 'p'

    - name: INFO: Group stg when second-last char is 's'
      group_by:
        key: "stg"
      when: node_name is string and (node_name | length) >= 2 and node_name[-2] == 's'

    - name: INFO: Add the real hostname to in-memory inventory with top_group
      add_host:
        name: "{{ node_name }}"
        groups: "{{ top_group }}"
        ansible_connection: local

    - name: INFO: Attach category groups to the added host if they exist
      block:
        - name: INFO: Attach server_iac
          add_host:
            name: "{{ node_name }}"
            groups: "server_iac"
          when: "'server_iac' in group_names"

        - name: INFO: Attach server_swarm_manager
          add_host:
            name: "{{ node_name }}"
            groups: "server_swarm_manager"
          when: "'server_swarm_manager' in group_names"

        - name: INFO: Attach server_swarm_host
          add_host:
            name: "{{ node_name }}"
            groups: "server_swarm_host"
          when: "'server_swarm_host' in group_names"

        - name: INFO: Attach server_utility
          add_host:
            name: "{{ node_name }}"
            groups: "server_utility"
          when: "'server_utility' in group_names"

        - name: INFO: Attach desktop_general
          add_host:
            name: "{{ node_name }}"
            groups: "desktop_general"
          when: "'desktop_general' in group_names"

        - name: INFO: Attach desktop_development
          add_host:
            name: "{{ node_name }}"
            groups: "desktop_development"
          when: "'desktop_development' in group_names"

        - name: INFO: Attach prod
          add_host:
            name: "{{ node_name }}"
            groups: "prod"
          when: "'prod' in group_names"

        - name: INFO: Attach stg
          add_host:
            name: "{{ node_name }}"
            groups: "stg"
          when: "'stg' in group_names"

    - name: INFO: Show final groups for the node (debug)
      debug:
        msg:
          - "group_names={{ group_names }}"
          - "groups_keys={{ groups.keys() | list }}"

- name: INFO: Routed execution on the node (runs under the node's hostname)
  hosts: "{{ node_name }}"
  gather_facts: true
  connection: local
  tasks:
    - name: INFO: Debug group_names for routed play
      debug:
        var: group_names

    - name: INFO: Route to server tasks
      include_tasks: tasks/servers.yml
      when: "'server_all' in group_names or 'servers' in group_names"

    - name: INFO: Route to desktop tasks
      include_tasks: tasks/desktops.yml
      when: "'desktop_all' in group_names or 'desktops' in group_names"
